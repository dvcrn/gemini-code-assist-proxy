#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const { spawn } = require("child_process");

const { startUpdateCheck } = require("./update_check");

const exe = process.platform === "win32" ? "gemini-code-assist-proxy.exe" : "gemini-code-assist-proxy";
const binPath = path.join(__dirname, exe);

const PKG = (() => {
  try {
    return require("./package.json");
  } catch {
    return null;
  }
})();

if (!fs.existsSync(binPath)) {
  console.error(`Binary not found: ${binPath}`);
  process.exit(1);
}

if (process.platform !== "win32") {
  try {
    fs.chmodSync(binPath, 0o755);
  } catch {}
}

const child = spawn(binPath, process.argv.slice(2), { stdio: "inherit", windowsHide: true });

// Best-effort update notice (cached + short timeout).
// Aborts on command exit so it never delays shutdown.
const updateAbort = new AbortController();
startUpdateCheck({ installedVersion: PKG && PKG.version, signal: updateAbort.signal });

child.on("exit", (code) => {
  try {
    updateAbort.abort();
  } catch {}
  process.exitCode = code == null ? 1 : code;
});
child.on("error", (err) => {
  console.error(err.message);
  process.exitCode = 1;
});

